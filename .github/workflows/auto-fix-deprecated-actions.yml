name: Auto-fix Deprecated Actions

on:
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

jobs:
  scan-and-fix:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Scan for deprecated actions/cache versions
      id: scan
      run: |
        echo "Scanning for deprecated actions/cache versions..."
        DEPRECATED_FOUND=false
        
        # Search for actions/cache@v1.x or actions/cache@v2.x (including patch versions)
        if grep -rE "actions/cache@v(1|2)(\.[0-9]+){0,2}" .github/workflows/ 2>/dev/null; then
          echo "Found deprecated actions/cache versions"
          DEPRECATED_FOUND=true
        else
          echo "No deprecated actions/cache versions found"
        fi
        
        echo "deprecated_found=$DEPRECATED_FOUND" >> $GITHUB_OUTPUT
    
    - name: Replace deprecated actions/cache with v4
      if: steps.scan.outputs.deprecated_found == 'true'
      run: |
        echo "Replacing deprecated actions/cache versions with v4..."
        
        # Find all workflow files
        find .github/workflows -name "*.yml" -o -name "*.yaml" | while read -r file; do
          # Replace actions/cache@v1.x with actions/cache@v4 (including patch versions)
          sed -i -E 's#actions/cache@v1(\.[0-9]+){0,2}([^0-9.]|$)#actions/cache@v4\2#g' "$file"
          
          # Replace actions/cache@v2.x with actions/cache@v4 (including patch versions)
          sed -i -E 's#actions/cache@v2(\.[0-9]+){0,2}([^0-9.]|$)#actions/cache@v4\2#g' "$file"
          
          echo "Processed: $file"
        done
        
        echo "Replacement complete"
    
    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "No changes to commit"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected"
        fi
    
    - name: Create Pull Request
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update actions/cache to v4"
        title: "chore: Update deprecated actions/cache to v4"
        body: |
          ## ðŸ¤– Automated Update
          
          This PR automatically updates deprecated `actions/cache` versions to `actions/cache@v4`.
          
          ### Changes
          - âœ… Replaced `actions/cache@v1` with `actions/cache@v4`
          - âœ… Replaced `actions/cache@v2` with `actions/cache@v4`
          
          ### Why v4?
          - Better performance and caching efficiency
          - Improved compression algorithms
          - Support for larger cache sizes
          - Active maintenance and security updates
          
          ### Migration Notes
          The v4 action is backward compatible with v1 and v2 configurations. No breaking changes expected.
          
          ---
          *This PR was automatically generated by the auto-fix-deprecated-actions workflow*
        branch: chore/auto-update-actions-cache-v4
        delete-branch: true
        labels: |
          automated
          dependencies
          github-actions
